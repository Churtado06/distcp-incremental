name: DistCP Environment Variables Test

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      user_name:
        description: 'GCP Username'
        required: true
        default: 'churtado_gcp1'
      

env:
  # Global environment variables
  PYTHON_VERSION: '3.9'
  GCP_REGION: ${{ secrets.REGION }} # us-central1
  BUCKET_NAME: ${{ secrets.BUCKET_NAME }} # source-files-data-distcp

jobs:
  test-with-env-vars:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }} # Use the selected environment (dev/staging/prod)
    
    # Job-level environment variables
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      USER_NAME_GOOGLE: ${{ github.event.inputs.user_name }}
      SOURCE_FILES_DATA_BUCKET: ${{ secrets.BUCKET_NAME }} # source-files-data-distcp
      COMPOSER_URL_ID: ${{ secrets.COMPOSER_URL_ID }} # 3eed80d0e54a4be78b9dd56d2b2f63bd
      DAG_ID: 'distcp_incremental_data_load'
      GCP_REGION: ${{ secrets.REGION }} # us-central1
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('.github/requirements.txt', 'distcp-incremental-tech-talk/cloud_function_composer2/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: pip install -r .github/requirements.txt
    
    - name: Display environment variables
      run: |
        echo "=== Environment Variables ==="
        echo "Environment: $ENVIRONMENT"
        echo "User: $USER_NAME_GOOGLE"
        echo "Bucket: $SOURCE_FILES_DATA_BUCKET"
        echo "Region: $GCP_REGION"
        echo "Composer URL ID: $COMPOSER_URL_ID"
        echo "DAG ID: $DAG_ID"
    
    - name: Test shell script with env vars
      run: |
        echo "=== Testing Shell Script ==="
        # Make script executable and test with our env vars
        chmod +x distcp-incremental-tech-talk/initialize_onprem_cluster.sh
        # Dry run - just show what would be executed
        echo "Script would use USER_NAME_GOOGLE: $USER_NAME_GOOGLE"
        echo "Script would use SOURCE_FILES_DATA_BUCKET: $SOURCE_FILES_DATA_BUCKET"
    
    - name: Run flake8 with environment context
      id: flake8_validation
      env:
        FLAKE8_CONFIG: '--max-line-length=88 --extend-ignore=E203,W503'
      run: |
        echo "=== Flake8 Linting (Environment: $ENVIRONMENT) ==="
        flake8 distcp-incremental-tech-talk/cloud_function_composer2/ $FLAKE8_CONFIG
        echo "Flake8 completed for $ENVIRONMENT environment"
    
    - name: Run pytest with environment variables
      if: failure() && steps.flake8_validation.outcome == 'failure'
      env:
        PYTEST_ENV: ${{ env.ENVIRONMENT }}
        TEST_USER: ${{ env.USER_NAME_GOOGLE }}
        TEST_BUCKET: ${{ env.SOURCE_FILES_DATA_BUCKET }}
        # Pass all required environment variables to pytest
        USER_NAME_GOOGLE: ${{ env.USER_NAME_GOOGLE }}
        SOURCE_FILES_DATA_BUCKET: ${{ env.SOURCE_FILES_DATA_BUCKET }}
        ENVIRONMENT: ${{ env.ENVIRONMENT }}
        COMPOSER_URL_ID: ${{ env.COMPOSER_URL_ID }}
        DAG_ID: ${{ env.DAG_ID }}
        GCP_REGION: ${{ env.GCP_REGION }}
      run: |
        echo "=== Running Tests (Environment: $PYTEST_ENV) ==="
        pytest distcp-incremental-tech-talk/tests/ -v -s
    
  deploy-simulation:
    needs: test-with-env-vars
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }} # Use the selected environment
    if: github.event.inputs.environment != 'prod'
    
    env:
      DEPLOY_ENV: ${{ github.event.inputs.environment }}
      
    steps:
    - name: Simulate deployment
      run: |
        echo "=== Deployment Simulation ==="
        echo "Deploying to environment: $DEPLOY_ENV"
        echo "Would deploy with the following configuration:"
        echo "- User: ${{ github.event.inputs.user_name }}"
        echo "- Bucket: $SOURCE_FILES_DATA_BUCKET"
        echo "- Region: $GCP_REGION"
        
        if [ "$DEPLOY_ENV" = "prod" ]; then
          echo "Production deployment blocked in this workflow"
          exit 1
        else
          echo "Deployment to $DEPLOY_ENV would succeed"
        fi